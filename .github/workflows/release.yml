name: Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Matches v1.0.0, v2.1.3, etc.

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT
          
      - name: Create release archive
        run: |
          echo "ðŸ“¦ Creating release archive for ${{ steps.version.outputs.VERSION }}"
          
          # Create a clean directory structure
          mkdir -p slimstore-release
          
          # Copy necessary files and directories
          echo "Copying files..."
          cp -r public slimstore-release/
          cp -r scripts slimstore-release/
          cp schema.sql slimstore-release/
          cp README.md slimstore-release/
          cp .secrets-sample.yml slimstore-release/
          
          # Create .gitignore for the release
          cat > slimstore-release/.gitignore << 'EOF'
          # Secrets and sensitive files
          .secrets.yml
          .secrets.yaml
          client_secret.json
          backup-*.sql
          
          # PHP
          vendor/
          composer.lock
          
          # IDE
          .idea/
          .vscode/
          
          # OS
          .DS_Store
          Thumbs.db
          
          # Temporary files
          temp_install/
          *.tmp
          EOF
          
          # Create the zip file
          echo "Creating ZIP archive..."
          cd slimstore-release
          zip -r ../slimstore-${{ steps.version.outputs.VERSION }}.zip . -x "*.git*"
          cd ..
          
          # Create checksums
          echo "Generating checksums..."
          sha256sum slimstore-${{ steps.version.outputs.VERSION }}.zip > slimstore-${{ steps.version.outputs.VERSION }}.zip.sha256
          
          # Show archive contents
          echo "Archive contents:"
          unzip -l slimstore-${{ steps.version.outputs.VERSION }}.zip | head -20
          
          # Show file sizes
          echo ""
          echo "File sizes:"
          ls -lh slimstore-${{ steps.version.outputs.VERSION }}.zip*
          
      - name: Generate release notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸš€ SlimStorage ${{ steps.version.outputs.VERSION }}
          
          ### ðŸ“¥ Installation
          
          #### One-File Installer (Recommended)
          
          1. Download `install.php` from the assets below
          2. Upload it to your web server
          3. Navigate to `https://yourdomain.com/install.php`
          4. Follow the installation wizard
          5. Delete `install.php` after installation
          
          The installer will automatically:
          - âœ… Download and extract this release
          - âœ… Guide you through configuration
          - âœ… Set up the database
          - âœ… Create your `.secrets.yml` file
          
          #### Manual Installation
          
          1. Download `slimstore-${{ steps.version.outputs.VERSION }}.zip`
          2. Extract to your web server
          3. Create `.secrets.yml` (see `.secrets-sample.yml`)
          4. Import `schema.sql` to your database
          5. Configure your web server
          
          #### Update Existing Installation
          
          1. Download `install.php` from the assets below
          2. Upload it to your existing SlimStorage directory
          3. Navigate to `https://yourdomain.com/install.php?update=1`
          4. Follow the update wizard
          5. Delete `install.php` after update
          
          Your `.secrets.yml` and database will be preserved during updates.
          
          ---
          
          ### ðŸ“¦ What's Included
          
          - âœ… Complete SlimStorage application
          - âœ… Database schema (`schema.sql`)
          - âœ… Configuration template (`.secrets-sample.yml`)
          - âœ… Deployment scripts
          - âœ… Comprehensive README
          
          ### ðŸ”§ Requirements
          
          - PHP 8.1+
          - MySQL 5.7+ or MariaDB 10.3+
          - PDO MySQL extension
          - cURL extension
          - ZipArchive extension (for installer)
          
          ### ðŸ” Security
          
          Verify your download integrity:
          ```bash
          sha256sum -c slimstore-${{ steps.version.outputs.VERSION }}.zip.sha256
          ```
          
          ### ðŸ“š Documentation
          
          - [README](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/README.md)
          - [Report Issues](https://github.com/${{ github.repository }}/issues)
          - [Discussions](https://github.com/${{ github.repository }}/discussions)
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.VERSION_NUMBER }}...HEAD
          EOF
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: SlimStorage ${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            slimstore-${{ steps.version.outputs.VERSION }}.zip
            slimstore-${{ steps.version.outputs.VERSION }}.zip.sha256
            install.php
            schema.sql
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: slimstore-${{ steps.version.outputs.VERSION }}
          path: |
            slimstore-${{ steps.version.outputs.VERSION }}.zip
            slimstore-${{ steps.version.outputs.VERSION }}.zip.sha256
          retention-days: 90

